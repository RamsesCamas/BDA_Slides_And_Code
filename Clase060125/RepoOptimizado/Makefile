.PHONY: help up down restart logs migrate db shell build clean rebuild status

help: ## Muestra esta ayuda
	@echo 'Uso: make [target]'
	@echo ''
	@echo 'Targets disponibles:'
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

up: ## Inicia los servicios en segundo plano
	docker compose up -d
	@echo "âœ… Servicios iniciados"
	@echo "   - PostgreSQL: localhost:5432"
	@echo "   - Database: mydb"
	@echo "   - User: postgres"

down: ## Detiene y elimina los servicios
	docker compose down
	@echo "âœ… Servicios detenidos"

restart: down up ## Reinicia los servicios

logs: ## Muestra los logs de los servicios
	docker compose logs -f

db: ## Ejecuta comandos en la base de datos (ej: make db cmd="SELECT version();")
	@docker compose exec -T db psql -U postgres -d mydb -c "$(cmd)"

shell: ## Abre un shell de psql
	docker compose exec db psql -U postgres -d mydb

migrate: ## Ejecuta las migraciones (scripts SQL)
	@echo "ğŸ”„ Ejecutando migraciones..."
	@docker compose exec -T db psql -U postgres -d mydb -f /sql/01_schema.sql && \
	 echo "âœ… Schema aplicado" || echo "âŒ Error aplicando schema"
	@docker compose exec -T db psql -U postgres -d mydb -f /sql/02_seed.sql && \
	 echo "âœ… Seed aplicado" || echo "âŒ Error aplicando seed"
	@docker compose exec -T db psql -U postgres -d mydb -f /sql/03_queries.sql > /dev/null && \
	 echo "âœ… Queries ejecutadas" || echo "âš ï¸  Algunas queries pueden fallar (normal si hay datos)"

migrate-schema: ## Ejecuta solo el schema
	@echo "ğŸ”„ Aplicando schema..."
	@docker compose exec -T db psql -U postgres -d mydb -f /sql/01_schema.sql && \
	 echo "âœ… Schema aplicado"

migrate-seed: ## Ejecuta solo el seed
	@echo "ğŸ”„ Aplicando seed..."
	@docker compose exec -T db psql -U postgres -d mydb -f /sql/02_seed.sql && \
	 echo "âœ… Seed aplicado"

run-queries: ## Ejecuta las queries y muestra resultados
	@echo "ğŸ”„ Ejecutando queries..."
	@docker compose exec db psql -U postgres -d mydb -f /sql/03_queries.sql

reset: down migrate ## Reinicia todo y ejecuta migraciones

build: ## Construye las imÃ¡genes
	docker compose build
	@echo "âœ… ImÃ¡genes construidas"

clean: ## Limpia contenedores, redes y volÃºmenes
	docker compose down -v
	docker compose rm -f
	docker volume prune -f
	@echo "âœ… Limpieza completada"

rebuild: clean build up ## Reconstruye todo desde cero

status: ## Muestra el estado de los servicios
	@echo "ğŸ“Š Estado de los servicios:"
	@docker compose ps
	@echo ""
	@echo "ğŸ“¦ VolÃºmenes:"
	@docker volume ls | grep repo-optimizado || echo "  (no hay volÃºmenes)"

test: ## Ejecuta pruebas de conexiÃ³n
	@echo "ğŸ§ª Probando conexiÃ³n a PostgreSQL..."
	@docker compose exec -T db psql -U postgres -d mydb -c "SELECT version();" | head -3 && \
	 echo "âœ… ConexiÃ³n exitosa" || echo "âŒ Error de conexiÃ³n"

inspect: ## Muestra informaciÃ³n de las tablas
	@echo "ğŸ“‹ Inspeccionando base de datos..."
	@docker compose exec -T db psql -U postgres -d mydb -c "\dt"
	@echo ""
	@echo "ğŸ“Š Filas por tabla:"
	@docker compose exec -T db psql -U postgres -d mydb -c \
	 "SELECT schemaname, tablename, n_live_tup FROM pg_stat_user_tables;"
